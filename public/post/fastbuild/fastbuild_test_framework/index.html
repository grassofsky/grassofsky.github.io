

There are two possible situations that led to this error:
  1. You haven&#39;t copied the config.toml yet. See https://github.com/olOwOlo/hugo-theme-even#installation 
  2. You have an incompatible update. See https://github.com/olOwOlo/hugo-theme-even/blob/master/CHANGELOG.md#400-2018-11-06 

有两种可能的情况会导致这个错误发生:
  1. 你还没有复制 config.toml 参考 https://github.com/olOwOlo/hugo-theme-even/blob/master/README-zh.md#installation 
  2. 你进行了一次不兼容的更新 参考 https://github.com/olOwOlo/hugo-theme-even/blob/master/CHANGELOG.md#400-2018-11-06 
<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="utf-8">
  <meta http-equiv="X-UA-Compatible" content="IE=edge,chrome=1">
  <title>fastbuild源码解析-test framework - Notepad Online</title>
  <meta name="renderer" content="webkit" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"/>

<meta http-equiv="Cache-Control" content="no-transform" />
<meta http-equiv="Cache-Control" content="no-siteapp" />

<meta name="theme-color" content="#f8f5ec" />
<meta name="msapplication-navbutton-color" content="#f8f5ec">
<meta name="apple-mobile-web-app-capable" content="yes">
<meta name="apple-mobile-web-app-status-bar-style" content="#f8f5ec">


<meta name="author" content="Zhong Xiewei" /><meta name="description" content="fastbuild源码解析-test framework test framework使用来干什么的？ test framework是一款类似于gtest的单元测试框架，但是相比" /><meta name="keywords" content="Hugo, theme, even" />






<meta name="generator" content="Hugo 0.60.1 with theme even" />


<link rel="canonical" href="http://127.0.0.1:1313/post/fastbuild/fastbuild_test_framework/" />
<link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png">
<link rel="icon" type="image/png" sizes="32x32" href="/favicon-32x32.png">
<link rel="icon" type="image/png" sizes="16x16" href="/favicon-16x16.png">
<link rel="manifest" href="/manifest.json">
<link rel="mask-icon" href="/safari-pinned-tab.svg" color="#5bbad5">


<link href="/dist/even.c2a46f00.min.css" rel="stylesheet">
<link href="/lib/fancybox/jquery.fancybox-3.1.20.min.css" rel="stylesheet">


<meta property="og:title" content="fastbuild源码解析-test framework" />
<meta property="og:description" content="fastbuild源码解析-test framework test framework使用来干什么的？ test framework是一款类似于gtest的单元测试框架，但是相比" />
<meta property="og:type" content="article" />
<meta property="og:url" content="http://127.0.0.1:1313/post/fastbuild/fastbuild_test_framework/" />
<meta property="article:published_time" content="2018-04-04T00:00:00+00:00" />
<meta property="article:modified_time" content="2018-04-04T00:00:00+00:00" />
<meta itemprop="name" content="fastbuild源码解析-test framework">
<meta itemprop="description" content="fastbuild源码解析-test framework test framework使用来干什么的？ test framework是一款类似于gtest的单元测试框架，但是相比">
<meta itemprop="datePublished" content="2018-04-04T00:00:00&#43;00:00" />
<meta itemprop="dateModified" content="2018-04-04T00:00:00&#43;00:00" />
<meta itemprop="wordCount" content="2282">



<meta itemprop="keywords" content="" /><meta name="twitter:card" content="summary"/>
<meta name="twitter:title" content="fastbuild源码解析-test framework"/>
<meta name="twitter:description" content="fastbuild源码解析-test framework test framework使用来干什么的？ test framework是一款类似于gtest的单元测试框架，但是相比"/>

<!--[if lte IE 9]>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/classlist/1.1.20170427/classList.min.js"></script>
<![endif]-->

<!--[if lt IE 9]>
  <script src="https://cdn.jsdelivr.net/npm/html5shiv@3.7.3/dist/html5shiv.min.js"></script>
  <script src="https://cdn.jsdelivr.net/npm/respond.js@1.4.2/dest/respond.min.js"></script>
<![endif]-->

</head>
<body>
  <div id="mobile-navbar" class="mobile-navbar">
  <div class="mobile-header-logo">
    <a href="/" class="logo">Even</a>
  </div>
  <div class="mobile-navbar-icon">
    <span></span>
    <span></span>
    <span></span>
  </div>
</div>
<nav id="mobile-menu" class="mobile-menu slideout-menu">
  <ul class="mobile-menu-list">
    <a href="/">
        <li class="mobile-menu-item">Home</li>
      </a><a href="/post/">
        <li class="mobile-menu-item">Archives</li>
      </a><a href="/tags/">
        <li class="mobile-menu-item">Tags</li>
      </a><a href="/categories/">
        <li class="mobile-menu-item">Categories</li>
      </a>
  </ul>
</nav>
  <div class="container" id="mobile-panel">
    <header id="header" class="header">
        <div class="logo-wrapper">
  <a href="/" class="logo">Even</a>
</div>

<nav class="site-navbar">
  <ul id="menu" class="menu">
    <li class="menu-item">
        <a class="menu-item-link" href="/">Home</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/post/">Archives</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/tags/">Tags</a>
      </li><li class="menu-item">
        <a class="menu-item-link" href="/categories/">Categories</a>
      </li>
  </ul>
</nav>
    </header>

    <main id="main" class="main">
      <div class="content-wrapper">
        <div id="content" class="content">
          <article class="post">
    
    <header class="post-header">
      <h1 class="post-title">fastbuild源码解析-test framework</h1>

      <div class="post-meta">
        <span class="post-time"> 2018-04-04 </span>
        <div class="post-category">
            <a href="/categories/fastbuild/"> fastbuild </a>
            </div>
        
      </div>
    </header>

    <div class="post-toc" id="post-toc">
  <h2 class="post-toc-title">Contents</h2>
  <div class="post-toc-content always-active">
    <nav id="TableOfContents">
  <ul>
    <li><a href="#test-framework">test framework使用来干什么的？</a></li>
    <li><a href="#test-framework1">test framework使用示例</a></li>
    <li><a href="#test-framework2">test framework具体实现</a>
      <ul>
        <li><a href="#unittesth">UnitTest.h代码浏览</a></li>
        <li><a href="#unittestmanagerh">UnitTestManager.h代码浏览</a></li>
        <li><a href="#unittestmanagercpp">UnitTestManager.cpp代码浏览</a></li>
      </ul>
    </li>
  </ul>
</nav>
  </div>
</div>
    <div class="post-content">
      <h1 id="fastbuildtest-framework">fastbuild源码解析-test framework</h1>
<h2 id="test-framework">test framework使用来干什么的？</h2>
<p>test framework是一款类似于gtest的单元测试框架，但是相比较而言更加的轻量级，仅用于对fastbuild中各个模块的代码进行单元测试。</p>
<h2 id="test-framework1">test framework使用示例</h2>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">// StdStringTest.cpp
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Inludes
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;TestFramework/UnitTest.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">/**
</span><span style="color:#75715e"> * \brief 每个一继承鱼UnitTest的类是一个testgraoup，
</span><span style="color:#75715e"> *        它的内部可以实现多个测试用例
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">TestStdString</span> <span style="color:#f92672">:</span> <span style="color:#66d9ef">public</span> UnitTest
{
<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// 对继承的函数进行声明，包括
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// virtual void RunTests();
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// virtual const char* GetName() const;
</span><span style="color:#75715e"></span>    DECLARE_TESTS

    <span style="color:#66d9ef">void</span> TestEmpty() <span style="color:#66d9ef">const</span>; <span style="color:#75715e">//&lt; 独立的测试用例
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TestEqual</span>() <span style="color:#66d9ef">const</span>;
};

<span style="color:#75715e">// Register Tests
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">// 实现成员函数，此处借用宏定义，简化具体实现
</span><span style="color:#75715e"></span>REGISTER_TESTS_BEGIN(TestStdString)
    REGISTER_TEST(TestEmpty)
    REGISTER_TEST(TestEqual)
REGISTER_TESTS_END

<span style="color:#75715e">// 编写具体的测试用例
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> TestStdString<span style="color:#f92672">:</span><span style="color:#f92672">:</span>TestEmpty() <span style="color:#66d9ef">const</span>
{
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string strEmpty;
    TEST_ASSERT(strEmpty.empty());
}

<span style="color:#66d9ef">void</span> TestStdString<span style="color:#f92672">:</span><span style="color:#f92672">:</span>TestEqual() <span style="color:#66d9ef">const</span>
{
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string strFirst <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">hello</span><span style="color:#e6db74">&#34;</span>;
    std<span style="color:#f92672">:</span><span style="color:#f92672">:</span>string strSecond;
    TEST_ASSERT(strFirst <span style="color:#f92672">=</span><span style="color:#f92672">=</span> strSecond);
    strSecond <span style="color:#f92672">=</span> strFirst;
    TEST_ASSERT(strFirst <span style="color:#f92672">=</span><span style="color:#f92672">=</span> strSecond);
}

<span style="color:#66d9ef">int</span> <span style="color:#a6e22e">main</span>()
{
    <span style="color:#75715e">// 将testgroup注册到UnitTestManager中
</span><span style="color:#75715e"></span>    REGISTER_TESTGROUP(TestStdString);

    <span style="color:#75715e">// 构造unitTestManager，调用RunTests来运行上述注册的testgroup
</span><span style="color:#75715e"></span>    UnitTestManager utm;
    <span style="color:#66d9ef">bool</span> allPassed <span style="color:#f92672">=</span> utm.RunTests();
    <span style="color:#66d9ef">return</span> allPassed <span style="color:#f92672">?</span> <span style="color:#ae81ff">0</span> <span style="color:#f92672">:</span> <span style="color:#f92672">-</span><span style="color:#ae81ff">1</span>;
}
</code></pre></div><p>从示例代码中可以看出testgramework使用的步骤，基本上包括：</p>
<ul>
<li>从UnitTest派生出针对特定测试的子类</li>
<li>实现自己的测试用例</li>
<li>将测试用例进行注册</li>
<li>将子类进行注册</li>
<li>运行所有注册了的testgroup</li>
</ul>
<h2 id="test-framework2">test framework具体实现</h2>
<p>test framework实现比较简单，包括两个类，一个抽象类，<code>UnitTest</code>，对它的继承就可以实现自己的单元测试；另一个类是<code>UnitTestManager</code>，用来对<code>UnitTest</code>进行管理。</p>
<h3 id="unittesth">UnitTest.h代码浏览</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">// UnitTest.h - interface for a unit test
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">pragma once</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;UnitTestManager.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// UnitTest - Tests derive from this interface
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">/**
</span><span style="color:#75715e"> * UnitTest是一个抽象类，从它的实现中，可以看出链表的痕迹，成员变量
</span><span style="color:#75715e"> * `UnitTest * m_NextTestGroup;`,
</span><span style="color:#75715e"> * 可以从当前的UnitTest获取下一个UnitTest。
</span><span style="color:#75715e"> */</span>
<span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnitTest</span>
{
<span style="color:#66d9ef">protected</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// explicit表示这个类的构造不支持隐式转换的构造
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">explicit</span>        UnitTest() { m_NextTestGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>; }
    <span style="color:#75715e">// default属于c++11引入的特性
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">virtual</span> <span style="color:#f92672">~</span>UnitTest() <span style="color:#f92672">=</span> <span style="color:#66d9ef">default</span>;

    <span style="color:#75715e">// 运行当前testgroup中的所有test case
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RunTests</span>() <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#75715e">// 获取Test类的名字
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> <span style="color:#a6e22e">GetName</span>() <span style="color:#66d9ef">const</span> <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;

    <span style="color:#75715e">// Run before and after each test
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">PreTest</span>() <span style="color:#66d9ef">const</span> {}
    <span style="color:#66d9ef">virtual</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">PostTest</span>() <span style="color:#66d9ef">const</span> {}

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    <span style="color:#75715e">// UnitTestManager是UnitTest的友元类，
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// 能够访问UnitTest中的私有成员
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">friend</span> <span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnitTestManager</span>;
    <span style="color:#75715e">// 指向下一个TestGroup
</span><span style="color:#75715e"></span>    UnitTest <span style="color:#f92672">*</span> m_NextTestGroup;
};

<span style="color:#75715e">// macros
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">// assert宏，如果传入的表达式为true，则不进行处理
</span><span style="color:#75715e"></span><span style="color:#75715e">// 否则输出哪个文件哪一行出错的内容
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define TEST_ASSERT( expression )                                   \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    do {                                                            \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    PRAGMA_DISABLE_PUSH_MSVC(4127)                                  \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        if ( !( expression ) )                                      \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        {                                                           \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">            if ( UnitTestManager::AssertFailure(  #expression, __FILE__, __LINE__ ) ) \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">            {                                                       \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">                BREAK_IN_DEBUGGER;                                      \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">            }                                                       \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        }                                                           \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    } while ( false );                                              \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    PRAGMA_DISABLE_POP_MSVC</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 在子类中声明函数
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define DECLARE_TESTS                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    virtual void RunTests();                                        \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    virtual const char * GetName() const;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 用于注册单个的测试用例，Begin,Register，and end
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define REGISTER_TESTS_BEGIN( testGroupName )                       \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    void testGroupName##Register()                                  \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    {                                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        UnitTestManager::RegisterTestGroup( new testGroupName );    \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    }                                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    const char * testGroupName::GetName() const                     \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    {                                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        return #testGroupName;                                      \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    }                                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    void testGroupName::RunTests()                                  \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    {                                                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        UnitTestManager &amp; utm = UnitTestManager::Get();             \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        (void)utm;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define REGISTER_TEST( testFunction )                               \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        utm.TestBegin( this, #testFunction );                       \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        testFunction();                                             \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        utm.TestEnd();</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">define REGISTER_TESTS_END                                          \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">    }</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// 向UnitTestManager中注册特定的testgroup
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">define REGISTER_TESTGROUP( testGroupName )                         \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        extern void testGroupName##Register();                      \</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">        testGroupName##Register();</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">//------------------------------------------------------------------------------
</span></code></pre></div><h3 id="unittestmanagerh">UnitTestManager.h代码浏览</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">// UnitTestManager
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">pragma once</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Includes
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Env/Assert.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Env/Types.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Time/Timer.h&#34;  //&lt; 用于运行时间的计算</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Forward Declarations
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnitTest</span>;

<span style="color:#75715e">// UnitTestManager
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">class</span> <span style="color:#a6e22e">UnitTestManager</span>
{
<span style="color:#66d9ef">public</span><span style="color:#f92672">:</span>
    UnitTestManager();
    <span style="color:#f92672">~</span>UnitTestManager();

    <span style="color:#75715e">// run all tests, or tests from a group
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">RunTests</span>( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> testGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span> );

    <span style="color:#75715e">// singleton behaviour
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef RELEASE</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> UnitTestManager <span style="color:#f92672">&amp;</span> Get() { <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>s_Instance; }
    <span style="color:#75715e">#</span><span style="color:#75715e">else</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">static</span>        UnitTestManager <span style="color:#f92672">&amp;</span> Get();
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">inline</span> <span style="color:#66d9ef">bool</span>                  <span style="color:#a6e22e">IsValid</span>() { <span style="color:#66d9ef">return</span> ( s_Instance <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> ); }

    <span style="color:#75715e">// tests register (using the test declaration macros) via this interface
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">RegisterTestGroup</span>( UnitTest <span style="color:#f92672">*</span> testGroup );

    <span style="color:#75715e">// When tests are being executed, they are wrapped with these
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TestBegin</span>( UnitTest <span style="color:#f92672">*</span> testGroup, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> testName );
    <span style="color:#66d9ef">void</span> <span style="color:#a6e22e">TestEnd</span>();

    <span style="color:#75715e">// TEST_ASSERT uses this interface to notify of assertion failures
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">bool</span> <span style="color:#a6e22e">AssertFailure</span>( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> message, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> file, <span style="color:#66d9ef">uint32_t</span> line );

<span style="color:#66d9ef">private</span><span style="color:#f92672">:</span>
    Timer       m_Timer;

    <span style="color:#66d9ef">enum</span> <span style="color:#960050;background-color:#1e0010">:</span><span style="color:#960050;background-color:#1e0010"> </span><span style="color:#a6e22e">uint32_t</span> { MAX_TESTS <span style="color:#f92672">=</span> <span style="color:#ae81ff">1024</span> };  <span style="color:#75715e">//&lt; 支持的最大testgroup数量
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">struct</span> <span style="color:#a6e22e">TestInfo</span>
    {
        TestInfo() <span style="color:#f92672">:</span>m_TestGroup( <span style="color:#66d9ef">nullptr</span> ), m_TestName( <span style="color:#66d9ef">nullptr</span> ), m_Passed( false ), m_MemoryLeaks( false ), m_TimeTaken( <span style="color:#ae81ff">0.0f</span> ) {}

        UnitTest <span style="color:#f92672">*</span>      m_TestGroup;      <span style="color:#75715e">// 含有的UnitTest
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span>    m_TestName;       <span style="color:#75715e">// UnitTest的名字
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span>            m_Passed;         <span style="color:#75715e">// 记录该测试是否通过
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">bool</span>            m_MemoryLeaks;    <span style="color:#75715e">// 记录该测试是否有内存泄漏
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">float</span>           m_TimeTaken;      <span style="color:#75715e">// 记录该测试花费的时间
</span><span style="color:#75715e"></span>    };
    <span style="color:#66d9ef">static</span> <span style="color:#66d9ef">uint32_t</span>     s_NumTests;                <span style="color:#75715e">// 记录有多少个UnitTest
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> TestInfo     s_TestInfos[ MAX_TESTS ];  <span style="color:#75715e">// 记录对应的TestInfo
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">static</span> UnitTestManager <span style="color:#f92672">*</span> s_Instance;  <span style="color:#75715e">// UnitTestManager实例
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">static</span> UnitTest <span style="color:#f92672">*</span> s_FirstTest;        <span style="color:#75715e">// 起始的UnitTest
</span><span style="color:#75715e"></span>};

<span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>
</code></pre></div><h3 id="unittestmanagercpp">UnitTestManager.cpp代码浏览</h3>
<div class="highlight"><pre style="color:#f8f8f2;background-color:#272822;-moz-tab-size:4;-o-tab-size:4;tab-size:4"><code class="language-c++" data-lang="c++"><span style="color:#75715e">// UnitTestManager.cpp
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Includes
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;UnitTestManager.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;UnitTest.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Env/Assert.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Env/Types.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Mem/MemTracker.h&#34;     // 内存泄漏监控</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Profile/Profile.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Strings/AString.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&#34;Core/Tracing/Tracing.h&#34;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;string.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">if defined( __WINDOWS__ )</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#</span><span style="color:#75715e">include</span> <span style="color:#75715e">&lt;windows.h&gt;</span><span style="color:#75715e">
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// Static Data
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">/*static*/</span> <span style="color:#66d9ef">uint32_t</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>s_NumTests( <span style="color:#ae81ff">0</span> );    <span style="color:#75715e">//&lt; 记录当前处理第几个Test Case
</span><span style="color:#75715e"></span><span style="color:#75715e">/*static*/</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>TestInfo UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>s_TestInfos[ MAX_TESTS ];
<span style="color:#75715e">/*static*/</span> UnitTestManager <span style="color:#f92672">*</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>s_Instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
<span style="color:#75715e">/*static*/</span> UnitTest <span style="color:#f92672">*</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>s_FirstTest <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;

<span style="color:#75715e">// CONSTRUCTOR
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>UnitTestManager()
{
    <span style="color:#75715e">// manage singleton
</span><span style="color:#75715e"></span>    ASSERT( s_Instance <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span> );
    s_Instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span>;

    <span style="color:#75715e">// if we&#39;re running outside the debugger, we don&#39;t want
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// failures to pop up a dialog.  We want them to throw so
</span><span style="color:#75715e"></span>    <span style="color:#75715e">// the test framework can catch the exception
</span><span style="color:#75715e"></span>    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef ASSERTS_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( IsDebuggerAttached() <span style="color:#f92672">=</span><span style="color:#f92672">=</span> false )
        {
            AssertHandler<span style="color:#f92672">:</span><span style="color:#f92672">:</span>SetThrowOnAssert( true );
        }
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>}

<span style="color:#75715e">// DESTRUCTOR
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span><span style="color:#f92672">~</span>UnitTestManager()
{
    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef ASSERTS_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( IsDebuggerAttached() <span style="color:#f92672">=</span><span style="color:#f92672">=</span> false )
        {
            AssertHandler<span style="color:#f92672">:</span><span style="color:#f92672">:</span>SetThrowOnAssert( false );
        }
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#75715e">// free all registered tests
</span><span style="color:#75715e"></span>    UnitTest <span style="color:#f92672">*</span> testGroup <span style="color:#f92672">=</span> s_FirstTest;
    <span style="color:#66d9ef">while</span> ( testGroup )
    {
        UnitTest <span style="color:#f92672">*</span> next <span style="color:#f92672">=</span> testGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup;
        FDELETE testGroup;
        testGroup <span style="color:#f92672">=</span> next;
    }

    <span style="color:#75715e">// manage singleton
</span><span style="color:#75715e"></span>    ASSERT( s_Instance <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">this</span> );
    s_Instance <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
}

<span style="color:#75715e">// Get
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">#</span><span style="color:#75715e">ifdef DEBUG</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    <span style="color:#75715e">/*static*/</span> UnitTestManager <span style="color:#f92672">&amp;</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>Get()
    {
        ASSERT( s_Instance );
        <span style="color:#66d9ef">return</span> <span style="color:#f92672">*</span>s_Instance;
    }
<span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
<span style="color:#75715e">// RegisterTest
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">/*static*/</span> <span style="color:#66d9ef">void</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>RegisterTestGroup( UnitTest <span style="color:#f92672">*</span> testGroup )
{
    <span style="color:#75715e">// first ever test? place as head of list
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">if</span> ( s_FirstTest <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span> )
    {
        s_FirstTest <span style="color:#f92672">=</span> testGroup;
        <span style="color:#66d9ef">return</span>;
    }

    <span style="color:#75715e">// link to end of list
</span><span style="color:#75715e"></span>    UnitTest <span style="color:#f92672">*</span> thisGroup <span style="color:#f92672">=</span> s_FirstTest;
loop:
    <span style="color:#66d9ef">if</span> ( thisGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup <span style="color:#f92672">=</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span> )
    {
        thisGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup <span style="color:#f92672">=</span> testGroup;
        <span style="color:#66d9ef">return</span>;
    }
    thisGroup <span style="color:#f92672">=</span> thisGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup;
    <span style="color:#66d9ef">goto</span> loop;
}

<span style="color:#75715e">// RunTests
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">bool</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>RunTests( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> testGroup )
{
    <span style="color:#75715e">// check for compile time filter
</span><span style="color:#75715e"></span>    UnitTest <span style="color:#f92672">*</span> test <span style="color:#f92672">=</span> s_FirstTest;
    <span style="color:#66d9ef">while</span> ( test )
    {
        <span style="color:#66d9ef">if</span> ( testGroup <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span> )
        {
            <span style="color:#75715e">// is this test the one we want?
</span><span style="color:#75715e"></span>            <span style="color:#66d9ef">if</span> ( AString<span style="color:#f92672">:</span><span style="color:#f92672">:</span>StrNCmp( test<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>GetName(), testGroup, strlen( testGroup ) ) <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> )
            {
                <span style="color:#75715e">// no -skip it
</span><span style="color:#75715e"></span>                test <span style="color:#f92672">=</span> test<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup;
                <span style="color:#66d9ef">continue</span>;
            }
        }

        OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
        OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Test Group: %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, test<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>GetName() );
        <span style="color:#66d9ef">try</span>
        {
            test<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>RunTests();
        }
        <span style="color:#66d9ef">catch</span> (...)
        {
            OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> - Test &#39;%s&#39; *** FAILED ***</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, s_TestInfos[ s_NumTests <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> ].m_TestName );
            s_TestInfos[ s_NumTests <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> ].m_TestGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>PostTest();
        }
        test <span style="color:#f92672">=</span> test<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>m_NextTestGroup;
    }

    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">------------------------------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Summary For All Tests</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );

    <span style="color:#75715e">// 在所有测试结束之后，对s_TestInfos数组进行遍历，打印出结果
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">uint32_t</span> numPassed <span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span>;
    <span style="color:#66d9ef">float</span> totalTime <span style="color:#f92672">=</span> <span style="color:#ae81ff">0.0f</span>;
    UnitTest <span style="color:#f92672">*</span> lastGroup <span style="color:#f92672">=</span> <span style="color:#66d9ef">nullptr</span>;
    <span style="color:#66d9ef">for</span> ( size_t i<span style="color:#f92672">=</span><span style="color:#ae81ff">0</span>; i<span style="color:#f92672">&lt;</span>s_NumTests; <span style="color:#f92672">+</span><span style="color:#f92672">+</span>i )
    {
        <span style="color:#66d9ef">const</span> TestInfo<span style="color:#f92672">&amp;</span> info <span style="color:#f92672">=</span> s_TestInfos[ i ];
        <span style="color:#66d9ef">if</span> ( info.m_TestGroup <span style="color:#f92672">!</span><span style="color:#f92672">=</span> lastGroup )
        {
            OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">------------------------------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
            OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">             : %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, info.m_TestGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>GetName() );
            lastGroup <span style="color:#f92672">=</span> info.m_TestGroup;
        }

        <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> status <span style="color:#f92672">=</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">OK</span><span style="color:#e6db74">&#34;</span>;
        <span style="color:#66d9ef">if</span> ( info.m_Passed )
        {
            <span style="color:#f92672">+</span><span style="color:#f92672">+</span>numPassed;
        }
        <span style="color:#66d9ef">else</span>
        {
            status <span style="color:#f92672">=</span> ( info.m_MemoryLeaks ) <span style="color:#f92672">?</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FAIL (LEAKS)</span><span style="color:#e6db74">&#34;</span> <span style="color:#f92672">:</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">FAIL</span><span style="color:#e6db74">&#34;</span>;
        }

        OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%12s : %5.3fs : %s</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, status, info.m_TimeTaken, info.m_TestName );
        totalTime <span style="color:#f92672">+</span><span style="color:#f92672">=</span> info.m_TimeTaken;
    }
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">------------------------------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Passed: %u / %u (%u failures) in %2.3fs</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, numPassed, s_NumTests, ( s_NumTests <span style="color:#f92672">-</span> numPassed ), totalTime );
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">------------------------------------------------------------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );

    <span style="color:#66d9ef">return</span> ( s_NumTests <span style="color:#f92672">=</span><span style="color:#f92672">=</span> numPassed );
}

<span style="color:#75715e">// TestBegin
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>TestBegin( UnitTest <span style="color:#f92672">*</span> testGroup, <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> testName )
{
    <span style="color:#75715e">// record info for this test
</span><span style="color:#75715e"></span>    TestInfo<span style="color:#f92672">&amp;</span> info <span style="color:#f92672">=</span> s_TestInfos[ s_NumTests ];
    info.m_TestGroup <span style="color:#f92672">=</span> testGroup;
    info.m_TestName <span style="color:#f92672">=</span> testName;
    <span style="color:#f92672">+</span><span style="color:#f92672">+</span>s_NumTests;

    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> - Test &#39;%s&#39;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, testName );
    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef MEMTRACKER_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        MemTracker<span style="color:#f92672">:</span><span style="color:#f92672">:</span>Reset();
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>    m_Timer.Start();

    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef PROFILING_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        ProfileManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>Start( testName );
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    testGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>PreTest();
}

<span style="color:#75715e">// TestEnd
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#66d9ef">void</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>TestEnd()
{
    TestInfo<span style="color:#f92672">&amp;</span> info <span style="color:#f92672">=</span> s_TestInfos[ s_NumTests <span style="color:#f92672">-</span> <span style="color:#ae81ff">1</span> ];

    info.m_TestGroup<span style="color:#f92672">-</span><span style="color:#f92672">&gt;</span>PostTest();

    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef PROFILING_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        ProfileManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>Stop();

        <span style="color:#75715e">// flush the profiling buffers, but don&#39;t profile the sync itself
</span><span style="color:#75715e"></span>        <span style="color:#75715e">// (because it leaves an outstanding memory alloc, it looks like a leak)
</span><span style="color:#75715e"></span>        ProfileManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>SynchronizeNoTag();
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    <span style="color:#66d9ef">float</span> timeTaken <span style="color:#f92672">=</span> m_Timer.GetElapsed();

    info.m_TimeTaken <span style="color:#f92672">=</span> timeTaken;

    <span style="color:#75715e">#</span><span style="color:#75715e">ifdef MEMTRACKER_ENABLED</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>        <span style="color:#66d9ef">if</span> ( MemTracker<span style="color:#f92672">:</span><span style="color:#f92672">:</span>GetCurrentAllocationCount() <span style="color:#f92672">!</span><span style="color:#f92672">=</span> <span style="color:#ae81ff">0</span> )
        {
            info.m_MemoryLeaks <span style="color:#f92672">=</span> true;
            OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> - Test &#39;%s&#39; in %2.3fs : *** FAILED (Memory Leaks)***</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, info.m_TestName, timeTaken );
            MemTracker<span style="color:#f92672">:</span><span style="color:#f92672">:</span>DumpAllocations();
            TEST_ASSERT( false );
            <span style="color:#66d9ef">return</span>;
        }
    <span style="color:#75715e">#</span><span style="color:#75715e">endif</span><span style="color:#75715e">
</span><span style="color:#75715e"></span>
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74"> - Test &#39;%s&#39; in %2.3fs : PASSED</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span>, info.m_TestName, timeTaken );
    info.m_Passed <span style="color:#f92672">=</span> true;
}

<span style="color:#75715e">// Assert
</span><span style="color:#75715e"></span><span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span><span style="color:#75715e">/*static*/</span> <span style="color:#66d9ef">bool</span> UnitTestManager<span style="color:#f92672">:</span><span style="color:#f92672">:</span>AssertFailure( <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> message,
                                                <span style="color:#66d9ef">const</span> <span style="color:#66d9ef">char</span> <span style="color:#f92672">*</span> file,
                                                <span style="color:#66d9ef">uint32_t</span> line )
{
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-------- TEST ASSERTION FAILED --------</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">%s(%i): Assert: %s</span><span style="color:#e6db74">&#34;</span>, file, line, message );
    OUTPUT( <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">-----^^^ TEST ASSERTION FAILED ^^^-----</span><span style="color:#ae81ff">\n</span><span style="color:#e6db74">&#34;</span> );

    <span style="color:#66d9ef">if</span> ( IsDebuggerAttached() )
    {
        <span style="color:#66d9ef">return</span> true; <span style="color:#75715e">// tell the calling code to break at the failure sight
</span><span style="color:#75715e"></span>    }

    <span style="color:#75715e">// throw will be caught by the unit test framework and noted as a failure
</span><span style="color:#75715e"></span>    <span style="color:#66d9ef">throw</span> <span style="color:#e6db74"></span><span style="color:#e6db74">&#34;</span><span style="color:#e6db74">Test Failed</span><span style="color:#e6db74">&#34;</span>;
}

<span style="color:#75715e">//------------------------------------------------------------------------------
</span><span style="color:#75715e"></span>
</code></pre></div>
    </div>

    
<footer class="post-footer">
      
      <nav class="post-nav">
        <a class="prev" href="/post/fastbuild/fastbuild_memory_mem/">
            <i class="iconfont icon-left"></i>
            <span class="prev-text nav-default">fastbuild源码解析-memory-mem</span>
            <span class="prev-text nav-mobile">Prev</span>
          </a>
        <a class="next" href="/post/deeplearning/double_linear_regression/">
            <span class="next-text nav-default">二元线性回归分析</span>
            <span class="next-text nav-mobile">Next</span>
            <i class="iconfont icon-right"></i>
          </a>
      </nav>
    </footer>
  </article>
        </div>
        

  

  

      </div>
    </main>

    <footer id="footer" class="footer">
      <div class="social-links">
      <a href="mailto:grass-of-sky@163.com" class="iconfont icon-email" title="email"></a>
      <a href="http://www.github.com/grassofsky" class="iconfont icon-github" title="github"></a>
  <a href="http://127.0.0.1:1313/index.xml" type="application/rss+xml" class="iconfont icon-rss" title="rss"></a>
</div>

<div class="copyright">
  <span class="power-by">
    Powered by <a class="hexo-link" href="https://gohugo.io">Hugo</a>
  </span>
  <span class="division">|</span>
  <span class="theme-info">
    Theme - 
    <a class="theme-link" href="https://github.com/olOwOlo/hugo-theme-even">Even</a>
  </span>

  

  <span class="copyright-year">
    &copy; 
    2017 - 
    2019
    <span class="heart">
      <i class="iconfont icon-heart"></i>
    </span>
    <span class="author">Zhong Xiewei</span>
  </span>
</div>
    </footer>

    <div class="back-to-top" id="back-to-top">
      <i class="iconfont icon-up"></i>
    </div>
  </div>
  <script type="text/javascript" src="/lib/jquery/jquery-3.2.1.min.js"></script>
  <script type="text/javascript" src="/lib/slideout/slideout-1.0.1.min.js"></script>
  <script type="text/javascript" src="/lib/fancybox/jquery.fancybox-3.1.20.min.js"></script>
<script type="text/javascript" src="/dist/even.26188efa.min.js"></script>
  <script type="text/javascript">
    window.MathJax = {
      tex2jax: {inlineMath: [['$','$'], ['\\(','\\)']]},
      showProcessingMessages: false,
      messageStyle: 'none'
    };
  </script>
  <script async src="https://cdn.jsdelivr.net/npm/mathjax@2.7.5/MathJax.js?config=TeX-MML-AM_CHTML"  integrity="sha256-nvJJv9wWKEm88qvoQl9ekL2J+k/RWIsaSScxxlsrv8k=" crossorigin="anonymous"></script>








</body>
</html>
